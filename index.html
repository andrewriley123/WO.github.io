<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Weekly Workout Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 0;
      background: #f5f5f5;
      color: #222;
    }
    header {
      padding: 12px 16px;
      background: #111827;
      color: white;
    }
    header h1 {
      margin: 0;
      font-size: 1.1rem;
    }
    header p {
      margin: 4px 0 0;
      font-size: 0.8rem;
      opacity: 0.9;
    }
    .progress-bar-wrap {
      margin-top: 8px;
      background: #374151;
      border-radius: 999px;
      overflow: hidden;
      height: 8px;
    }
    .progress-bar {
      height: 8px;
      width: 0%;
      background: #10b981;
      transition: width 0.2s ease;
    }
    .day-tabs {
      display: flex;
      overflow-x: auto;
      background: #e5e7eb;
      padding: 4px;
      gap: 4px;
    }
    .day-tab {
      border: none;
      padding: 6px 10px;
      border-radius: 999px;
      background: #d1d5db;
      font-size: 0.8rem;
      cursor: pointer;
      white-space: nowrap;
    }
    .day-tab.active {
      background: #111827;
      color: white;
      font-weight: 600;
    }
    .content {
      padding: 12px 16px 24px;
    }
    .section {
      background: white;
      margin-bottom: 12px;
      padding: 10px 12px;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    }
    .section-title {
      font-weight: 600;
      font-size: 0.9rem;
      margin-bottom: 6px;
    }
    .checkbox-row {
      display: flex;
      align-items: center;
      margin: 4px 0;
      font-size: 0.9rem;
      flex-wrap: wrap;
      gap: 4px;
    }
    .checkbox-row input[type="checkbox"] {
      width: 18px;
      height: 18px;
      margin-right: 6px;
    }
    .exercise-label {
      flex: 1 1 auto;
      min-width: 120px;
    }
    .weight-input {
      flex: 0 0 80px;
      max-width: 100px;
      font-size: 0.8rem;
      padding: 3px 4px;
      border-radius: 4px;
      border: 1px solid #d1d5db;
    }
    .weight-input::placeholder {
      color: #9ca3af;
    }
    .day-progress {
      font-size: 0.8rem;
      margin-top: 4px;
      color: #4b5563;
    }
    .history-container {
      padding: 0 16px 24px;
    }
    .history-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 4px;
      margin-bottom: 6px;
      gap: 8px;
      flex-wrap: wrap;
    }
    .history-title {
      font-weight: 600;
      font-size: 0.9rem;
      color: #111827;
    }
    .history-buttons {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }
    .history-button {
      border: none;
      background: #111827;
      color: white;
      padding: 6px 10px;
      font-size: 0.8rem;
      border-radius: 999px;
      cursor: pointer;
      white-space: nowrap;
    }
    .history-button.reset {
      background: #b91c1c;
    }
    .history-button.secondary {
      background: #4b5563;
    }
    .history-button:active {
      opacity: 0.85;
    }
    .history-list {
      font-size: 0.8rem;
      color: #374151;
      background: #f9fafb;
      border-radius: 8px;
      padding: 8px 10px;
      max-height: 160px;
      overflow-y: auto;
      border: 1px solid #e5e7eb;
    }
    .history-item {
      padding: 4px 0;
      border-bottom: 1px solid #e5e7eb;
      cursor: pointer;
    }
    .history-item:last-child {
      border-bottom: none;
    }
    .history-week {
      font-weight: 600;
      color: #111827;
    }
    .history-meta {
      color: #6b7280;
    }
    .history-details {
      margin-top: 8px;
      font-size: 0.8rem;
      background: #f3f4f6;
      border-radius: 8px;
      padding: 8px 10px;
      border: 1px solid #e5e7eb;
      max-height: 260px;
      overflow-y: auto;
    }
    .history-details h4 {
      margin: 0 0 4px;
      font-size: 0.85rem;
      color: #111827;
    }
    .history-details-day {
      margin-top: 6px;
    }
    .history-details-day-title {
      font-weight: 600;
      margin-bottom: 2px;
      color: #111827;
    }
    .history-details-line {
      margin-left: 8px;
      margin-bottom: 2px;
      color: #374151;
    }
    .history-details-section {
      margin-left: 4px;
      margin-top: 3px;
      font-weight: 600;
      color: #4b5563;
    }
  </style>
</head>
<body>

<header>
  <h1>Weekly Workout</h1>
  <p id="weekly-progress-text">Weekly progress: 0%</p>
  <div class="progress-bar-wrap">
    <div class="progress-bar" id="weekly-progress-bar"></div>
  </div>
</header>

<div class="day-tabs" id="day-tabs"></div>

<div class="content">
  <div id="day-progress" class="day-progress"></div>
  <div id="day-content"></div>
</div>

<div class="history-container">
  <div class="history-header">
    <div class="history-title">History (by calendar week)</div>
    <div class="history-buttons">
      <button class="history-button" id="archive-week-btn">Archive This Week</button>
      <button class="history-button reset" id="reset-week-btn">Reset Week</button>
      <button class="history-button secondary" id="copy-weights-btn">Copy Last Week's Weights</button>
    </div>
  </div>
  <div id="history-list" class="history-list"></div>
  <div id="history-details" class="history-details">
    No history selected. Tap a week above to view its details.
  </div>
</div>

<script>
  // ---- DATA: Your full routine ----
  const daysData = [
    {
      name: "Monday",
      sections: [
        {
          title: "Medicine",
          exercises: ["Medicine"]
        },
        {
          title: "A. Power Circuit (Template – 10 reps, 3 sets)",
          exercises: [
            "Clean and Press",
            "Weighted Knee Raise",
            "Weighted Stepups",
            "Pullup",
            "Incline Pushup",
            "Triceps Dips"
          ]
        },
        {
          title: "B. Lower Back / Core Routine",
          exercises: [
            "Deadlifts – 4×6",
            "Back Extensions – 3×12",
            "Plank – 3×45 sec",
            "Glute Bridges – 4×10"
          ]
        }
      ]
    },
    {
      name: "Tuesday",
      sections: [
        {
          title: "Medicine",
          exercises: ["Medicine"]
        },
        {
          title: "A. Chest & Back (Template – 10 reps, 4 sets)",
          exercises: [
            "Incline Bench Press",
            "Pullup",
            "Incline Pushup",
            "Incline Pec Flys"
          ]
        },
        {
          title: "B. Lower Back / Core Routine",
          exercises: [
            "Cable Woodchoppers – 3×12/side",
            "Seated Hamstring Curls – 3×12",
            "Roman Chair Stretch – 2×45 sec",
            "Hip Flexor Stretch – 2×45 sec"
          ]
        }
      ]
    },
    {
      name: "Wednesday",
      sections: [
        {
          title: "Medicine",
          exercises: ["Medicine"]
        },
        {
          title: "A. Legs (Template – 10 reps, 4 sets)",
          exercises: [
            "Squat",
            "Straight-Leg Deadlift",
            "Hamstring Curl",
            "Weighted Lunge"
          ]
        },
        {
          title: "B. Lower Back / Core Routine",
          exercises: [
            "Barbell Hip Thrusts – 4×8",
            "Leg Press (feet high) – 4×10",
            "Abductor Machine – 3×15",
            "Back Extension Hold – 3×30 sec"
          ]
        }
      ]
    },
    {
      name: "Thursday",
      sections: [
        {
          title: "Medicine",
          exercises: ["Medicine"]
        },
        {
          title: "A. Shoulders & Arms (Template – 10 reps, 4 sets)",
          exercises: [
            "Incline Biceps Curls",
            "Triceps Dips",
            "Lateral Raises",
            "Shoulder Press"
          ]
        },
        {
          title: "B. Lower Back / Core Routine",
          exercises: [
            "Light Row Machine – 10 min",
            "Cat–Cow – 2×15",
            "Lumbar Rotation Stretch – 2×12/side",
            "Piriformis Stretch – 2×45 sec"
          ]
        }
      ]
    },
    {
      name: "Friday",
      sections: [
        {
          title: "Medicine",
          exercises: ["Medicine"]
        },
        {
          title: "A. Power Circuit (Template – 10 reps, 3 sets)",
          exercises: [
            "Clean and Press",
            "Weighted Knee Raise",
            "Weighted Stepups",
            "Pullup",
            "Incline Pushup",
            "Triceps Dips"
          ]
        },
        {
          title: "B. Lower Back / Core Routine",
          exercises: [
            "Cable Anti-Rotation Press (Pallof) – 4×10/side",
            "Dead Bug – 3×12",
            "Side Plank – 3×30 sec/side",
            "Reverse Hyper – 3×12 (if available)"
          ]
        }
      ]
    },
    {
      name: "Saturday",
      sections: [
        {
          title: "Medicine",
          exercises: ["Medicine"]
        },
        {
          title: "A. Lower Back / Strength Day",
          exercises: [
            "Trap Bar Deadlift – 5×5",
            "Glute-Ham Raise – 3×8",
            "Lat Pulldown – 3×12",
            "Farmer Carry – 3×1 min"
          ]
        }
      ]
    },
    {
      name: "Sunday",
      sections: [
        {
          title: "Medicine",
          exercises: ["Medicine"]
        },
        {
          title: "A. Around The World Ab Routine",
          exercises: [
            "Standard Crunch",
            "Knee-up Crunches",
            "Hip Lifts",
            "Oblique Crunches (Side 1)",
            "Side Plank Dips (Side 1)",
            "Pushups",
            "Oblique Crunches (Side 2)",
            "Side Plank Dips (Side 2)",
            "Heel Touches",
            "Bicycle Crunches",
            "Half-Up Twists"
          ]
        }
      ]
    }
  ];

  // Decide which exercises "involve weights"
  function isWeightedExercise(name) {
    const lower = name.toLowerCase();
    const keywords = [
      "clean", "press", "weighted", "curl", "deadlift",
      "bench", "squat", "lunge", "stepup", "stepups",
      "hip thrust", "leg press", "abductor", "row machine",
      "trap bar", "glute-ham", "lat pulldown", "farmer",
      "dumbbell", "barbell", "machine", "fly", "flys",
      "raises", "raise"
    ];
    return keywords.some(k => lower.includes(k));
  }

  // ---- STATE + STORAGE ----
  const STORAGE_KEY = "weeklyWorkoutState_v2";
  const HISTORY_KEY = "weeklyWorkoutHistory_v1";

  // state[id] = { checked: bool, weight: string }
  let state = loadState();
  let history = loadHistory();

  function loadState() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return {};
      const parsed = JSON.parse(raw);

      // normalize format
      const migrated = {};
      for (const [key, value] of Object.entries(parsed)) {
        if (typeof value === "boolean") {
          migrated[key] = { checked: value, weight: "" };
        } else if (typeof value === "object" && value !== null) {
          migrated[key] = {
            checked: !!value.checked,
            weight: value.weight || ""
          };
        }
      }
      return migrated;
    } catch (e) {
      console.warn("Could not load saved state", e);
      return {};
    }
  }

  function saveState() {
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    } catch (e) {
      console.warn("Could not save state", e);
    }
  }

  function loadHistory() {
    try {
      const raw = localStorage.getItem(HISTORY_KEY);
      if (!raw) return [];
      const parsed = JSON.parse(raw);
      if (Array.isArray(parsed)) return parsed;
      return [];
    } catch (e) {
      console.warn("Could not load history", e);
      return [];
    }
  }

  function saveHistory() {
    try {
      localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
    } catch (e) {
      console.warn("Could not save history", e);
    }
  }

  function makeId(dayName, sectionTitle, exerciseName) {
    return `${dayName}::${sectionTitle}::${exerciseName}`;
  }

  const dayTabsEl = document.getElementById("day-tabs");
  const dayContentEl = document.getElementById("day-content");
  const dayProgressEl = document.getElementById("day-progress");
  const weeklyProgressBarEl = document.getElementById("weekly-progress-bar");
  const weeklyProgressTextEl = document.getElementById("weekly-progress-text");
  const historyListEl = document.getElementById("history-list");
  const historyDetailsEl = document.getElementById("history-details");
  const archiveWeekBtn = document.getElementById("archive-week-btn");
  const resetWeekBtn = document.getElementById("reset-week-btn");
  const copyWeightsBtn = document.getElementById("copy-weights-btn");

  let currentDayIndex = 0;

  // ---- ISO WEEK HELPERS ----
  function getISOWeekInfo(date) {
    const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
    const dayNum = d.getUTCDay() || 7; // 1-7, Monday=1, Sunday=7
    d.setUTCDate(d.getUTCDate() + 4 - dayNum);
    const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
    const weekNo = Math.ceil(((d - yearStart) / 86400000 + 1) / 7);
    const year = d.getUTCFullYear();
    return { year, week: weekNo };
  }

  function currentWeekId() {
    const today = new Date();
    const { year, week } = getISOWeekInfo(today);
    return `${year}-W${String(week).padStart(2, "0")}`;
  }

  // ---- RENDER TABS ----
  function renderTabs() {
    dayTabsEl.innerHTML = "";
    daysData.forEach((day, index) => {
      const btn = document.createElement("button");
      btn.textContent = day.name;
      btn.className = "day-tab" + (index === currentDayIndex ? " active" : "");
      btn.addEventListener("click", () => {
        currentDayIndex = index;
        renderTabs();
        renderDay();
      });
      dayTabsEl.appendChild(btn);
    });
  }

  // ---- RENDER DAY ----
  function renderDay() {
    const day = daysData[currentDayIndex];
    dayContentEl.innerHTML = "";

    let total = 0;
    let completed = 0;

    day.sections.forEach(section => {
      const sectionDiv = document.createElement("div");
      sectionDiv.className = "section";

      const title = document.createElement("div");
      title.className = "section-title";
      title.textContent = section.title;
      sectionDiv.appendChild(title);

      section.exercises.forEach(exName => {
        const id = makeId(day.name, section.title, exName);
        if (!state[id]) state[id] = { checked: false, weight: "" };

        const exState = state[id];
        total += 1;
        if (exState.checked) completed += 1;

        const row = document.createElement("div");
        row.className = "checkbox-row";

        const box = document.createElement("input");
        box.type = "checkbox";
        box.checked = exState.checked;
        box.addEventListener("change", () => {
          exState.checked = box.checked;
          state[id] = exState;
          saveState();
          updateWeeklyProgress();
          renderDay();
        });

        const labelSpan = document.createElement("span");
        labelSpan.className = "exercise-label";
        labelSpan.textContent = exName;

        row.appendChild(box);
        row.appendChild(labelSpan);

        if (isWeightedExercise(exName) && exName.toLowerCase() !== "medicine") {
          const weightInput = document.createElement("input");
          weightInput.type = "text";
          weightInput.className = "weight-input";
          weightInput.placeholder = "Weight";
          weightInput.value = exState.weight || "";
          weightInput.addEventListener("change", () => {
            exState.weight = weightInput.value;
            state[id] = exState;
            saveState();
          });
          row.appendChild(weightInput);
        }

        sectionDiv.appendChild(row);
      });

      dayContentEl.appendChild(sectionDiv);
    });

    const percent = total === 0 ? 0 : Math.round((completed / total) * 100);
    dayProgressEl.textContent = `${day.name} progress: ${completed} of ${total} items (${percent}%)`;
  }

  // ---- WEEKLY PROGRESS ----
  function computeWeeklyProgress() {
    let total = 0;
    let completed = 0;

    daysData.forEach(day => {
      day.sections.forEach(section => {
        section.exercises.forEach(exName => {
          const id = makeId(day.name, section.title, exName);
          const exState = state[id];
          total += 1;
          if (exState && exState.checked) completed += 1;
        });
      });
    });

    const fraction = total === 0 ? 0 : completed / total;
    const percent = Math.round(fraction * 100);
    return { fraction, percent, total, completed };
  }

  function updateWeeklyProgress() {
    const { fraction, percent } = computeWeeklyProgress();
    weeklyProgressBarEl.style.width = (fraction * 100) + "%";
    weeklyProgressTextEl.textContent = `Weekly progress: ${percent}%`;
  }

  // ---- HISTORY RENDERING ----
  function renderHistory() {
    historyListEl.innerHTML = "";
    if (history.length === 0) {
      historyListEl.textContent = "No archived weeks yet. Tap \"Archive This Week\" when you finish a week.";
      historyDetailsEl.textContent = "No history selected. Tap a week above to view its details.";
      return;
    }

    history
      .slice()
      .sort((a, b) => (a.weekId < b.weekId ? 1 : -1)) // latest first
      .forEach(entry => {
        const item = document.createElement("div");
        item.className = "history-item";

        const title = document.createElement("div");
        title.className = "history-week";
        title.textContent = `${entry.weekId} — ${entry.progressPercent}% complete`;

        const meta = document.createElement("div");
        meta.className = "history-meta";
        meta.textContent = `Saved on ${entry.savedAt}`;

        item.appendChild(title);
        item.appendChild(meta);

        item.addEventListener("click", () => {
          renderHistoryDetails(entry);
        });

        historyListEl.appendChild(item);
      });
  }

  function renderHistoryDetails(entry) {
    const snapshot = entry.snapshot || {};
    const container = document.createElement("div");

    const header = document.createElement("h4");
    header.textContent = `Week ${entry.weekId} — ${entry.progressPercent}% complete`;
    container.appendChild(header);

    const meta = document.createElement("div");
    meta.style.marginBottom = "4px";
    meta.textContent = `Saved on ${entry.savedAt}`;
    container.appendChild(meta);

    daysData.forEach(day => {
      const dayDiv = document.createElement("div");
      dayDiv.className = "history-details-day";

      const dayTitle = document.createElement("div");
      dayTitle.className = "history-details-day-title";
      dayTitle.textContent = day.name;
      dayDiv.appendChild(dayTitle);

      day.sections.forEach(section => {
        const sectionTitle = document.createElement("div");
        sectionTitle.className = "history-details-section";
        sectionTitle.textContent = section.title;
        dayDiv.appendChild(sectionTitle);

        section.exercises.forEach(exName => {
          const id = makeId(day.name, section.title, exName);
          const exState = snapshot[id] || { checked: false, weight: "" };
          const line = document.createElement("div");
          line.className = "history-details-line";
          const checkMark = exState.checked ? "☑" : "☐";
          const weightText = exState.weight ? ` — ${exState.weight}` : "";
          line.textContent = `${checkMark} ${exName}${weightText}`;
          dayDiv.appendChild(line);
        });
      });

      container.appendChild(dayDiv);
    });

    historyDetailsEl.innerHTML = "";
    historyDetailsEl.appendChild(container);
  }

  // ---- ARCHIVE WEEK ----
  archiveWeekBtn.addEventListener("click", () => {
    const weekId = currentWeekId();
    const { percent } = computeWeeklyProgress();
    const now = new Date();
    const savedAt =
      `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, "0")}-${String(now.getDate()).padStart(2, "0")} ` +
      `${String(now.getHours()).padStart(2, "0")}:${String(now.getMinutes()).padStart(2, "0")}`;

    const snapshot = JSON.parse(JSON.stringify(state));

    const existingIndex = history.findIndex(h => h.weekId === weekId);
    const entry = { weekId, progressPercent: percent, savedAt, snapshot };

    if (existingIndex >= 0) {
      history[existingIndex] = entry;
    } else {
      history.push(entry);
    }

    saveHistory();
    renderHistory();
    renderHistoryDetails(entry);
    alert(`Archived as ${weekId} (${percent}% complete).`);
  });

  // ---- RESET WEEK ----
  resetWeekBtn.addEventListener("click", () => {
    const confirmReset = confirm("Reset all current checkboxes and weights for this week?");
    if (!confirmReset) return;

    state = {};
    saveState();
    renderDay();
    updateWeeklyProgress();
    alert("Current week has been reset.");
  });

  // ---- COPY LAST WEEK'S WEIGHTS ----
  copyWeightsBtn.addEventListener("click", () => {
    if (history.length === 0) {
      alert("No archived weeks found to copy weights from.");
      return;
    }

    const currentId = currentWeekId();

    // Sort history by weekId ascending, then pick the latest week not equal to current
    const sorted = history.slice().sort((a, b) => a.weekId.localeCompare(b.weekId));
    let source = null;

    for (let i = sorted.length - 1; i >= 0; i--) {
      if (sorted[i].weekId !== currentId) {
        source = sorted[i];
        break;
      }
    }

    // If all entries are current week (or only one entry), just use the last one
    if (!source) {
      source = sorted[sorted.length - 1];
    }

    const snapshot = source.snapshot || {};

    daysData.forEach(day => {
      day.sections.forEach(section => {
        section.exercises.forEach(exName => {
          const id = makeId(day.name, section.title, exName);
          const prev = snapshot[id];
          if (prev && prev.weight) {
            if (!state[id]) state[id] = { checked: false, weight: "" };
            state[id].weight = prev.weight;
          }
        });
      });
    });

    saveState();
    renderDay();
    alert(`Copied weights from week ${source.weekId}.`);
  });

  // ---- INIT ----
  renderTabs();
  renderDay();
  updateWeeklyProgress();
  renderHistory();
</script>

</body>
</html>
